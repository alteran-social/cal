---
import Layout from '../../layouts/Layout.astro';
import { createAtProtoClient } from '../../lib/atproto/client';

const { handle } = Astro.params;

if (!handle) {
  return Astro.redirect('/');
}

let did: string | null = null;
let error: string | null = null;

try {
  const client = createAtProtoClient();
  did = await client.resolveHandle(handle);
} catch (e) {
  console.error('Error fetching user:', e);
  error = 'Unable to resolve user handle';
}
---

<Layout title={`Book with ${handle} - atproto Cal`}>
  <main style="max-width: 1000px; margin: 2rem auto; padding: 2rem;">
    <header style="text-align: center; margin-bottom: 3rem;">
      <h1 style="font-size: 2rem; margin-bottom: 0.5rem;">Book time with {handle}</h1>
      {did && <p style="color: #666; font-size: 0.9rem;">DID: {did}</p>}
    </header>

    {error ? (
      <div style="background: #fee; border: 1px solid #fcc; color: #c33; padding: 1rem; border-radius: 4px; text-align: center;">
        {error}
      </div>
    ) : (
      <div id="booking-app" data-did={did} data-handle={handle}>
        <!-- Date Selection -->
        <div class="step-1" style="text-align: center; margin-bottom: 2rem;">
          <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Select a Date</label>
          <input type="date" id="date-picker" style="padding: 0.75rem; border: 1px solid #ddd; border-radius: 4px; font-size: 1.1rem;" />
        </div>

        <!-- Slots Container -->
        <div id="slots-container" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 1rem; margin-bottom: 2rem;">
          <!-- Slots will be injected here -->
        </div>

        <div id="loading" style="display: none; text-align: center; color: #666;">
            Loading available times...
        </div>

        <div id="no-slots" style="display: none; text-align: center; color: #666; padding: 2rem; background: #f5f5f5; border-radius: 8px;">
            No available slots for this date.
        </div>

        <!-- Booking Form (Hidden initially) -->
        <div id="booking-form" style="display: none; max-width: 500px; margin: 0 auto; background: white; padding: 2rem; border-radius: 8px; border: 1px solid #e0e0e0;">
            <h3 style="margin-bottom: 1.5rem; text-align: center;">Confirm Booking</h3>
            <div style="margin-bottom: 1rem; text-align: center; font-weight: 500; color: #0066cc;" id="selected-time-display"></div>

            <form id="confirm-form" style="display: flex; flex-direction: column; gap: 1rem;">
                <input type="hidden" name="startTime" id="input-startTime" />
                <input type="hidden" name="endTime" id="input-endTime" />
                <input type="hidden" name="hostDid" value={did} />

                <div>
                    <label style="display: block; margin-bottom: 0.25rem; font-size: 0.9rem;">Your Email</label>
                    <input type="email" name="bookerEmail" required style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;" />
                </div>

                <div>
                    <label style="display: block; margin-bottom: 0.25rem; font-size: 0.9rem;">Notes</label>
                    <textarea name="bookerNote" rows="2" style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;"></textarea>
                </div>

                <button type="submit" style="background: #0066cc; color: white; padding: 0.75rem; border: none; border-radius: 4px; font-weight: 500; cursor: pointer;">
                    Confirm Booking
                </button>

                <button type="button" id="cancel-booking" style="background: transparent; color: #666; padding: 0.5rem; border: none; cursor: pointer; text-decoration: underline;">
                    Cancel
                </button>
            </form>
        </div>
      </div>
    )}

    <div style="text-align: center; margin-top: 3rem;">
      <a href="/" style="color: #0066cc;">
        ‚Üê Back to home
      </a>
    </div>
  </main>
</Layout>

<script>
  const did = document.getElementById('booking-app')?.dataset.did;
  const datePicker = document.getElementById('date-picker') as HTMLInputElement;
  const slotsContainer = document.getElementById('slots-container');
  const loading = document.getElementById('loading');
  const noSlots = document.getElementById('no-slots');
  const bookingForm = document.getElementById('booking-form');
  const confirmForm = document.getElementById('confirm-form') as HTMLFormElement;
  const cancelBtn = document.getElementById('cancel-booking');

  // Set min date to today
  if (datePicker) {
      datePicker.min = new Date().toISOString().split('T')[0];
      datePicker.addEventListener('change', fetchSlots);
  }

  if (cancelBtn) {
      cancelBtn.addEventListener('click', () => {
          bookingForm!.style.display = 'none';
          slotsContainer!.style.display = 'grid';
      });
  }

  if (confirmForm) {
      confirmForm.addEventListener('submit', async (e) => {
          e.preventDefault();
          const btn = confirmForm.querySelector('button[type="submit"]') as HTMLButtonElement;
          const originalText = btn.innerText;
          btn.innerText = 'Booking...';
          btn.disabled = true;

          const formData = new FormData(confirmForm);
          const data = Object.fromEntries(formData.entries());

          try {
              const res = await fetch('/api/book/create', {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify(data)
              });

              if (res.ok) {
                  alert('Booking Confirmed! Check your email.');
                  window.location.reload();
              } else {
                  const err = await res.json();
                  alert('Booking failed: ' + (err.error || 'Unknown error'));
              }
          } catch (error) {
              alert('Error submitting booking');
          } finally {
              btn.innerText = originalText;
              btn.disabled = false;
          }
      });
  }

  async function fetchSlots() {
      if (!datePicker.value || !did) return;

      slotsContainer!.innerHTML = '';
      bookingForm!.style.display = 'none';
      slotsContainer!.style.display = 'grid';
      loading!.style.display = 'block';
      noSlots!.style.display = 'none';

      const date = new Date(datePicker.value);
      const start = new Date(date);
      start.setUTCHours(0,0,0,0);
      const end = new Date(date);
      end.setUTCHours(23,59,59,999);

      try {
          const res = await fetch(`/api/availability/query?did=${did}&start=${start.toISOString()}&end=${end.toISOString()}`);
          const data = await res.json();

          loading!.style.display = 'none';

          if (data.slots && data.slots.length > 0) {
              data.slots.forEach((slot: any) => {
                  const startDetails = new Date(slot.start);
                  const endDetails = new Date(slot.end);

                  // Format time (HH:MM)
                  const timeStr = startDetails.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

                  const btn = document.createElement('button');
                  btn.className = 'slot-btn';
                  btn.style.cssText = `
                      padding: 1rem;
                      border: 1px solid #0066cc;
                      background: white;
                      color: #0066cc;
                      border-radius: 4px;
                      cursor: pointer;
                      font-weight: 500;
                  `;
                  btn.innerText = timeStr;
                  btn.onclick = () => selectSlot(slot);

                  slotsContainer!.appendChild(btn);
              });
          } else {
              noSlots!.style.display = 'block';
          }

      } catch (e) {
          console.error(e);
          loading!.style.display = 'none';
          alert('Error fetching slots');
      }
  }

  function selectSlot(slot: any) {
      const start = new Date(slot.start);
      const end = new Date(slot.end);
      const dateStr = start.toLocaleDateString();
      const timeStr = `${start.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})} - ${end.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}`;

      document.getElementById('selected-time-display')!.innerText = `${dateStr} @ ${timeStr}`;
      (document.getElementById('input-startTime') as HTMLInputElement).value = slot.start;
      (document.getElementById('input-endTime') as HTMLInputElement).value = slot.end;

      slotsContainer!.style.display = 'none';
      bookingForm!.style.display = 'block';
  }
</script>
