---
import Layout from '../../layouts/Layout.astro';
import { getSession } from '../../lib/auth/session';

const session = await getSession(Astro.request);

if (!session) {
  return Astro.redirect('/auth/login');
}
---

<Layout title="New Availability - atproto Cal">
  <main style="max-width: 800px; margin: 2rem auto; padding: 2rem;">
    <div style="background: white; border-radius: 8px; padding: 2rem;">
      <h1 style="margin-bottom: 0.5rem;">Create Availability Slot</h1>
      <p style="color: #666; margin-bottom: 2rem;">
        Define when you're available for bookings
      </p>

      <form method="POST" action="/api/availability" style="display: flex; flex-direction: column; gap: 1.5rem;">
        <div>
          <label for="title" style="display: block; margin-bottom: 0.5rem; font-weight: 500;">
            Title *
          </label>
          <input
            type="text"
            id="title"
            name="title"
            placeholder="e.g., 30-minute consultation"
            required
            style="width: 100%; padding: 0.75rem; border: 1px solid #ddd; border-radius: 4px; font-size: 1rem;"
          />
        </div>

        <div>
          <label for="description" style="display: block; margin-bottom: 0.5rem; font-weight: 500;">
            Description
          </label>
          <textarea
            id="description"
            name="description"
            rows="3"
            placeholder="What is this meeting for?"
            style="width: 100%; padding: 0.75rem; border: 1px solid #ddd; border-radius: 4px; font-size: 1rem; resize: vertical;"
          ></textarea>
        </div>

        <div>
          <label for="duration" style="display: block; margin-bottom: 0.5rem; font-weight: 500;">
            Duration (minutes) *
          </label>
          <select
            id="duration"
            name="duration"
            required
            style="width: 100%; padding: 0.75rem; border: 1px solid #ddd; border-radius: 4px; font-size: 1rem;"
          >
            <option value="15">15 minutes</option>
            <option value="30" selected>30 minutes</option>
            <option value="45">45 minutes</option>
            <option value="60">60 minutes</option>
            <option value="90">90 minutes</option>
          </select>
        </div>

        <div>
          <label for="autoAccept" style="display: block; margin-bottom: 0.5rem; font-weight: 500;">
            Booking approval *
          </label>
          <select
            id="autoAccept"
            name="autoAccept"
            required
            style="width: 100%; padding: 0.75rem; border: 1px solid #ddd; border-radius: 4px; font-size: 1rem;"
          >
            <option value="all">Auto-accept all bookings</option>
            <option value="follows">Auto-accept from people I follow</option>
            <option value="manual">Manual approval required</option>
          </select>
        </div>

        <div>
          <h3 style="margin-bottom: 1rem;">Weekly Schedule</h3>
          <p style="color: #666; margin-bottom: 1rem; font-size: 0.9rem;">
            Select the days and times you're available
          </p>
          
          <div id="schedule-slots" style="display: flex; flex-direction: column; gap: 1rem;">
            <div class="schedule-slot" style="display: grid; grid-template-columns: 120px 1fr 1fr 100px auto; gap: 0.5rem; align-items: center;">
              <select name="dayOfWeek[]" style="padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;">
                <option value="1">Monday</option>
                <option value="2">Tuesday</option>
                <option value="3">Wednesday</option>
                <option value="4">Thursday</option>
                <option value="5">Friday</option>
                <option value="6">Saturday</option>
                <option value="0">Sunday</option>
              </select>
              <input type="time" name="startTime[]" value="09:00" required style="padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;" />
              <input type="time" name="endTime[]" value="17:00" required style="padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;" />
              <input type="text" name="timezone[]" value="UTC" placeholder="Timezone" style="padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;" />
              <button type="button" class="remove-slot" style="padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px; background: white; cursor: pointer;">Remove</button>
            </div>
          </div>

          <button type="button" id="add-slot" style="margin-top: 1rem; padding: 0.5rem 1rem; border: 1px solid #0066cc; color: #0066cc; background: white; border-radius: 4px; cursor: pointer;">
            + Add Time Slot
          </button>
        </div>

        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
          <div>
            <label for="bufferBefore" style="display: block; margin-bottom: 0.5rem; font-weight: 500;">
              Buffer before (minutes)
            </label>
            <input
              type="number"
              id="bufferBefore"
              name="bufferBefore"
              min="0"
              value="0"
              style="width: 100%; padding: 0.75rem; border: 1px solid #ddd; border-radius: 4px; font-size: 1rem;"
            />
          </div>

          <div>
            <label for="bufferAfter" style="display: block; margin-bottom: 0.5rem; font-weight: 500;">
              Buffer after (minutes)
            </label>
            <input
              type="number"
              id="bufferAfter"
              name="bufferAfter"
              min="0"
              value="0"
              style="width: 100%; padding: 0.75rem; border: 1px solid #ddd; border-radius: 4px; font-size: 1rem;"
            />
          </div>
        </div>

        <div style="display: flex; gap: 1rem; padding-top: 1rem; border-top: 1px solid #eee;">
          <button
            type="submit"
            style="flex: 1; background: #0066cc; color: white; padding: 0.75rem; border: none; border-radius: 4px; font-size: 1rem; font-weight: 500; cursor: pointer;"
          >
            Create Availability
          </button>
          <a
            href="/dashboard"
            style="flex: 1; text-align: center; padding: 0.75rem; border: 1px solid #ddd; border-radius: 4px; text-decoration: none; color: #333;"
          >
            Cancel
          </a>
        </div>
      </form>
    </div>
  </main>

  <script>
    // Add slot functionality
    document.getElementById('add-slot')?.addEventListener('click', () => {
      const container = document.getElementById('schedule-slots');
      const newSlot = container?.querySelector('.schedule-slot')?.cloneNode(true) as HTMLElement;
      if (newSlot) {
        container?.appendChild(newSlot);
      }
    });

    // Remove slot functionality
    document.addEventListener('click', (e) => {
      if ((e.target as HTMLElement).classList.contains('remove-slot')) {
        const container = document.getElementById('schedule-slots');
        const slots = container?.querySelectorAll('.schedule-slot');
        if (slots && slots.length > 1) {
          (e.target as HTMLElement).closest('.schedule-slot')?.remove();
        }
      }
    });
  </script>
</Layout>
